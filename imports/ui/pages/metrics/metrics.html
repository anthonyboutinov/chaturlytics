<template name="Page_metrics">

  <div class="level">
    <div class="level-left">
      <div class="level-item">
        <h3 class="title">Metrics</h3>
      </div>
    </div>
    <div class="level-right">

      <div class="level-item">
        <button class="button toggle-display-notes">
          {{#unless displayNotes}}
            <span class="icon is-small">
              <i class="fas fa-fw fa-toggle-off" aria-hidden="true"></i>
            </span>
          {{else}}
            <span class="icon is-small">
              <i class="fas fa-fw fa-toggle-on" aria-hidden="true"></i>
            </span>
          {{/unless}}
          <span> Notes</span>
        </button>
      </div>

      {{#if skipOffDaysToggleApplicable}}
        <div class="level-item">
          <button class="button toggle-skip-offdays">
            {{#if skipOffDays}}
              <span class="icon is-small">
                <i class="fas fa-fw fa-toggle-off" aria-hidden="true"></i>
              </span>
            {{else}}
              <span class="icon is-small">
                <i class="fas fa-fw fa-toggle-on" aria-hidden="true"></i>
              </span>
            {{/if}}
            <span> Off-days</span>
          </button>
        </div>
      {{/if}}

      <div class="level-item">
        <div class="dropdown is-hoverable is-right">
          <div class="dropdown-trigger">
            <button class="button" aria-haspopup="true" aria-controls="dropdown-menu-metrics">
              <span>{{groupingLabel grouping}}</span>
              <span class="icon is-small">
                <i class="fas fa-angle-down" aria-hidden="true"></i>
              </span>
            </button>
          </div>
          <div class="dropdown-menu" role="menu" id="dropdown-menu-metrics">
            <div class="dropdown-content">
              <div class="dropdown-item"><p class="menu-label">Change grouping</p></div>
              <hr class="dropdown-divider">
              {{#each groupingOptions}}
                <a class="dropdown-item {{isActiveByEquals grouping this}} set-grouping" href="#">{{groupingLabel this}}</a>
              {{/each}}
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- <div class="box">
    Charts: 1.1) Broadcasts count / density, 1.2) time online dnesity, 2) income dneisty, 3.1) followers density, 3.2) viewers density
  </div> -->

  <table class="table is-fullwidth is-size-7 rows-aligned-middle" style="margin-bottom:300px;">
    <thead>
      <tr>
        <th>Timeframe</th>
        {{#unless isActiveByEquals grouping 'years'}}<th>Broadcasts</th>{{/unless}}
        <!-- <th>Number of<br>Broadcasts</th> -->
        <th>Time<br>Online</th>
        <!-- <th>Followers</th> -->
        <th>Income, TKN </th>
        <th>Average<br>Income per<br>Hour During<br>Broadcasts, TKN </th>
        <th>Extra Income, <span class="tag is-round" style="margin-top: -0.25em;">{{userCurrencyLabel}}</span> </th>
        <th>Total<br>Income, <span class="tag is-round" style="margin-top: -0.25em;">{{userCurrencyLabel}}</span></th>
        <th>Total<br>Avg Income<br>per Hour<br>During<br>Broadcasts, <span class="tag is-round" style="margin-top: -0.25em;">{{userCurrencyLabel}}</span></th>
        {{#if displayNotes}}<th style="width: 25vw;">Notes</th>{{/if}}
      </tr>
    </thead>
    <tfoot>
    </tfoot>
    <tbody>
      {{#if Template.subscriptionsReady}}
        {{#each metrics}}
          <tr class="{{rowClasses}}">
            <th class="{{rowClasses}} no-wrap">{{timeframe}}</th>
            {{#unless isActiveByEquals grouping 'years'}}<td class="p-b-0">
              {{#each sessions}}
                <div class="dropdown is-hoverable">
                  <div class="dropdown-trigger" aria-haspopup="true" aria-controls="dropdown-menu-session-{{@index}}">
                    <a href="/view/sessions/{{_id}}">
                      <div class="tag" style="margin-bottom:0.5em;">
                        {{sessionIndex @index}}
                      </div>
                    </a>
                  </div>
                  <div class="dropdown-menu is-wide" role="menu" id="dropdown-menu-session-{{@index}}">
                    <div class="dropdown-content">
                      <div class="dropdown-item"><p class="menu-label">Broadcast {{sessionIndex @index}}</p></div>
                      <div class="dropdown-item">
                        <p class="has-text-weight-bold">{{timeframeForSession}}</p>
                      </div>
                      <div class="dropdown-item">
                        <p class="has-text-weight-semibold">{{duration}}</p>
                        <p class="has-text-weight-semibold">
                          {{formatNumber deltaTokens}} TKN
                          {{#if extraIncome}}+ {{totalExtraIncome}}{{/if}}
                        </p>
                      </div>
                      {{#if note}}
                        <div class="dropdown-item">
                          <p class="has-text-grey">{{note}}</p>
                        </div>
                      {{/if}}
                      <hr class="dropdown-divider">
                      <a class="dropdown-item" href="/view/sessions/{{_id}}">
                        <i class="fas fa-fw fa-info-circle"></i>
                        Go to broadcast
                      </a>
                    </div>
                  </div>
                </div>
              {{/each}}
            </td>{{/unless}}
            <!-- <td class="has-text-right">{{formatNumber numBroadcasts}}</td> -->
            <td class="has-text-right no-wrap">{{timeOnline}}</td>
            <!-- <td class="has-text-right no-wrap">{{deltaFollowers}}</td> -->
            <td class="has-text-right no-wrap" __style="{{deltaTokensStyle}}">{{formatNumber deltaTokens}}</td>
            <td class="has-text-right no-wrap" __style="{{avgTokensStyle}}">{{formatNumber avgTokens}}</td>
            <td class="has-text-right no-wrap">{{formatNumber extraCurrency}}</td>
            <td class="has-text-right no-wrap" style="{{totalDeltaPrimaryCurrencyStyle}} border-left:2px solid #dbdbdb;">{{formatNumber totalDeltaPrimaryCurrency}}</td>
            <td class="has-text-right no-wrap" style="{{avgPrimaryCurrencyStyle}}">{{formatNumber avgPrimaryCurrency}}</td>
            {{#if displayNotes}}<td class="has-text-right">{{notes}}</td>{{/if}}
          </tr>
        {{/each}}
      {{else}}
        <tr><td colspan="11" class="has-text-grey has-text-centered" style="padding:2rem 1rem;">Loading...</td></tr>
      {{/if}}
    </tbody>
  </table>

</template>
